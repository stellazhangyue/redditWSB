# Results
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(quantmod)
library(PerformanceAnalytics)
library(ggplot2)
library(plyr)
library(scales)
library(ggcorrplot)
library(reshape2)
library(plotly)
library(patchwork)
library(maps)
library(mapdata)
library(lubridate)
library(treemap)
library(wordcloud2)
library(highcharter)
```

```{r}
light_blue <- '#88A8F2'
light_red <- '#EF856E'
green <- "#8DF186"
purple <- "#D5A7F1"
```

## What's the impact of r/wallstreetbet?

### General Public's interests on Google

#### Interest over time
```{r}
combined_web <- readr::read_csv("data/clean/gtrends/combined_web.csv")
combined_news <- readr::read_csv("data/clean/gtrends/combined_news.csv")

web <- combined_web %>%
  ggplot(aes(x=Week, y=score, color = keyword)) +
  geom_line() +
  ggtitle("Web Search Interest overtime")

news <- combined_news %>%
  ggplot(aes(x=Week, y=score, color = keyword)) +
  geom_line() +
  ggtitle("News Search Interest overtime")

web / news
```

The above two plots display the interest on the relative topics during the time period 2020-11-15 to 2021-11-15. Numbers represent search interest relative to the highest point on the chart for the given region and time. A value of 100 is the peak popularity for the term. A value of 50 means that the term is half as popular. A score of 0 means there was not enough data for this term.

#### Interest by subregion


## Stock Data and Information
### Stock Data Plot
The most Representative WSB stocks are `GME` and `AMC`. Also, these 2 stocks are the top 2 most widely discussed stocks in WallStreetBet sub-reddit analysed in Chapter 3 - cleaning. Therefore, we choose these 2 stocks and show the stock price and volume change in the past one year.

```{r}
getSymbols("GME",src='yahoo')
df_GME <- data.frame(Date=index(GME),coredata(GME))

# Generate Bollinger Bands
bbands <- BBands(GME[,c("GME.High","GME.Low","GME.Close")])

df_GME <- subset(cbind(df_GME, data.frame(bbands[,1:3])), Date >= "2020-12-01")

for (i in 1:length(df_GME[,1])) {
  if (df_GME$GME.Close[i] >= df_GME$GME.Open[i]) {
      df_GME$direction[i] = 'Increasing'
  } else {
      df_GME$direction[i] = 'Decreasing'
  }
}
i <- list(line = list(color = 'green'))
d <- list(line = list(color = 'red'))

# candlestick chart
fig <- df_GME %>% plot_ly(x = ~Date, type="candlestick",
          open = ~GME.Open, close = ~GME.Close,
          high = ~GME.High, low = ~GME.Low, name = "GME",
          increasing = i, decreasing = d)
fig <- fig %>% add_lines(x = ~Date, y = ~up , name = "Bollinger Bands",
            line = list(color = '#ccc', width = 0.5),
            legendgroup = "Bollinger Bands",
            hoverinfo = "none", inherit = F) 
fig <- fig %>% add_lines(x = ~Date, y = ~dn, name = "Bollinger Bands",
            line = list(color = '#ccc', width = 0.5),
            legendgroup = "Bollinger Bands", inherit = F,
            showlegend = FALSE, hoverinfo = "none") 
fig <- fig %>% add_lines(x = ~Date, y = ~mavg, name = "Moving Avg",
            line = list(color = '#E377C2', width = 0.5),
            hoverinfo = "none", inherit = F) 
fig <- fig %>% layout(yaxis = list(title = "Price"))

# volume chart
fig2 <- df_GME
fig2 <- fig2 %>% plot_ly(x=~Date, y=~GME.Volume, type='bar', name = "GME Volume",
          color = ~direction, colors = c('green','red')) 
fig2 <- fig2 %>% layout(yaxis = list(title = "Volume"))

# date slider 
rs <- list(visible = TRUE, x = 0.5, y = -0.055,
           xanchor = 'center', yref = 'paper',
           font = list(size = 9),
           buttons = list(
             list(count=1,
                  label='RESET',
                  step='all'),
             list(count=1,
                  label='1 YR',
                  step='year',
                  stepmode='backward'),
             list(count=6,
                  label='6 MO',
                  step='month',
                  stepmode='backward'),
             list(count=3,
                  label='3 MO',
                  step='month',
                  stepmode='backward'),
             list(count=1,
                  label='1 MO',
                  step='month',
                  stepmode='backward')
           ))

# combined plot
fig <- subplot(fig, fig2, heights = c(0.7,0.2), nrows=2,
             shareX = TRUE, titleY = TRUE)
fig <- fig %>% layout(title = paste("GME: 2020-12-01 -",Sys.Date()),
         xaxis = list(rangeselector = rs),
         legend = list(orientation = 'h', x = 0.5, y = 1,
                       xanchor = 'center', yref = 'paper',
                       font = list(size = 10),
                       bgcolor = 'transparent'))

fig
```

```{r}
getSymbols("AMC",src='yahoo')
df_AMC <- data.frame(Date=index(AMC),coredata(AMC))

# Generate Bollinger Bands
bbands <- BBands(AMC[,c("AMC.High","AMC.Low","AMC.Close")])

df_AMC <- subset(cbind(df_AMC, data.frame(bbands[,1:3])), Date >= "2020-12-01")

for (i in 1:length(df_AMC[,1])) {
  if (df_AMC$AMC.Close[i] >= df_AMC$AMC.Open[i]) {
      df_AMC$direction[i] = 'Increasing'
  } else {
      df_AMC$direction[i] = 'Decreasing'
  }
}
i <- list(line = list(color = 'green'))
d <- list(line = list(color = 'red'))

# candlestick chart
fig3 <- df_AMC %>% plot_ly(x = ~Date, type="candlestick",
          open = ~AMC.Open, close = ~AMC.Close,
          high = ~AMC.High, low = ~AMC.Low, name = "AMC",
          increasing = i, decreasing = d)
fig3 <- fig3 %>% add_lines(x = ~Date, y = ~up , name = "Bollinger Bands",
            line = list(color = '#ccc', width = 0.5),
            legendgroup = "Bollinger Bands",
            hoverinfo = "none", inherit = F) 
fig3 <- fig3 %>% add_lines(x = ~Date, y = ~dn, name = "Bollinger Bands",
            line = list(color = '#ccc', width = 0.5),
            legendgroup = "Bollinger Bands", inherit = F,
            showlegend = FALSE, hoverinfo = "none") 
fig3 <- fig3 %>% add_lines(x = ~Date, y = ~mavg, name = "Moving Avg",
            line = list(color = '#E377C2', width = 0.5),
            hoverinfo = "none", inherit = F) 
fig3 <- fig3 %>% layout(yaxis = list(title = "Price"))

# volume chart
fig4 <- df_AMC
fig4 <- fig4 %>% plot_ly(x=~Date, y=~AMC.Volume, type='bar', name = "AMC Volume",
          color = ~direction, colors = c('green','red')) 
fig4 <- fig4 %>% layout(yaxis = list(title = "Volume"))

# date slider 
rs <- list(visible = TRUE, x = 0.5, y = -0.055,
           xanchor = 'center', yref = 'paper',
           font = list(size = 9),
           buttons = list(
             list(count=1,
                  label='RESET',
                  step='all'),
             list(count=1,
                  label='1 YR',
                  step='year',
                  stepmode='backward'),
             list(count=6,
                  label='6 MO',
                  step='month',
                  stepmode='backward'),
             list(count=3,
                  label='3 MO',
                  step='month',
                  stepmode='backward'),
             list(count=1,
                  label='1 MO',
                  step='month',
                  stepmode='backward')
           ))

# combined plot
fig3 <- subplot(fig3, fig4, heights = c(0.7,0.2), nrows=2,
             shareX = TRUE, titleY = TRUE)
fig3 <- fig3 %>% layout(title = paste("AMC: 2020-12-01 -",Sys.Date()),
         xaxis = list(rangeselector = rs),
         legend = list(orientation = 'h', x = 0.5, y = 1,
                       xanchor = 'center', yref = 'paper',
                       font = list(size = 10),
                       bgcolor = 'transparent'))

fig3
```

From the above 2 graphs, we can clearly see that there are 2 waves of the WSB stocks, which are indicated by the sudden spike of the stock price as well as the sudden increase of the volume. These 2 waves are around January - Feburary and May - June period respectively. These 2 graphs actually double confirm with our previous claims. 

Also, the gray and red line in the price graph is the Bollinger Bands, which is the price level at 1 standard deviation level above and below the sample moving average of the price, which is able to capture the volatility of the stock. Generally, Bollinger bands is used to check whether prices are relatively high or low as comparing to the historical price. Here, we can see that for the beginning of the 2 waves, the price of both `GME` and `AMC` break the Bollinger upper bands, which suggests that the price of these 2 stocks are extremely high as comparing to the historical data. However, the Bollinger bands also adjusted themselves quickly to accommodate the sudden price change, so we can see that the price of these 2 stocks fall back within the Bollinger bands after a short period of time.

### Stock Risk Assessment
While the previous 2 graphs mainly focus on the price and volume aspects, there is one more aspect that are very important to the stock, which is risk. Risk can be measured by the standard deviation. Here, we would like to explore how the risk of the 2 stocks change before and after the 2 waves, which are `GME` and `AMC` respectively. Thus, we need to calculate the moving standard deviation of the 2 stocks over time.

Here, we take the closing price to be the one calculating the moving standard deviation since closing price is the most representative price among all the 5 prices. For each month, it is about 4 weeks and the stock market only opens in weekdays, thus, there are about 4*5 = 20 days with stock data every month. Therefore, we set the moving window to be 20, which is roughly about 1 month time. 

Also, we take the data since the start of last year because we want to see whether there is any difference in terms of the risk of `GME` and `AMC` by comparing the moving standard deviation before and after the 2 waves.
```{r}
getSymbols("GME",src='yahoo')
df_GME <- data.frame(Date=index(GME),coredata(GME))

df_GME <- subset(df_GME, Date >= "2020-01-01")
df_GME['moving_std'] <- rollapply(df_GME['GME.Close'], width = 20, FUN = sd, na.pad = TRUE)
ggplot(df_GME, aes(x=Date, y=moving_std)) +
  geom_line() +
  xlab("Date") +
  ylab('Moving Standard Deviation') + 
  ggtitle('Change of risk of GME over time')
```

```{r}
getSymbols("AMC",src='yahoo')
df_AMC <- data.frame(Date=index(AMC),coredata(AMC))

df_AMC <- subset(df_AMC, Date >= "2020-01-01")
df_AMC['moving_std'] <- rollapply(df_AMC['AMC.Close'], width = 20, FUN = sd, na.pad = TRUE)
ggplot(df_AMC, aes(x=Date, y=moving_std)) +
  geom_line() +
  xlab("Date") +
  ylab('Moving Standard Deviation') + 
  ggtitle('Change of risk of AMC over time')
```

From the 2 graphs above, we have following observations:

1. Around Jan/Feb and May/June period, there are huge changes for both `GME` and `AMC` in terms of risk.

2. `GME` has relatively higher risk than  `AMC` as `GME`'s moving standard deviation reached more than 100 while the highest moving standard deviation of `AMC` is about 13.

3. The risk of `GME` is highest in the first wave during Jan/Feb period while the risk of `AMC` is highest in the second wave during May/Jun period. This can be supported by the general knowledge that `GME` is the leading stock in the 1st wave while `AMC` is the leading stock in the 2nd wave.

### Most Popular Stocks
Besides studying about the 2 most representative stocks in WSBs, which are `GME` and `AMC` respectively, we could also study some other WSB stocks, which are not as popular as `GME` and `AMC` but they are still very representative and have received a lot of public attention.

Therefore, we extend our study to the top 10 mentioned stocks in the posts of WallStreetBets sub-reddit group. These 10 stocks has been identified in the Chapter 3 - Cleaning, which are: `GME`, `AMC`, `BB`, `NOK`, `SND`, `NAKD`, `PLTR`, `CLOV`, `RETA`, `MAR`, respectively.

Now, we can plot bar chart to show the count of posts that have mentioned about the stock for each stock.

```{r}
df <- read.csv('data/clean/reddit/ranked_possible_tickers_count.csv')
top_10_tickers <- c('GME','AMC','BB','NOK','SND','NAKD','PLTR','CLOV','RETA','MAR')
df %>% filter(possible_ticker %in% top_10_tickers) %>%
    ggplot(aes(x = fct_reorder(possible_ticker, desc(count)), y = count)) +
    geom_bar(stat = "identity") +
    ggtitle("Number of Posts Mentioned the Stock Ticker") +
    xlab("Stock Ticker") + 
    ylab("Count")
```

```{r}
df %>% 
  filter(possible_ticker %in% top_10_tickers) %>%
  mutate(ticker=paste(possible_ticker, count, sep ="\n"))%>%
  treemap(index = c("ticker"), vSize = "count", vColor = "count", type = "value", title = "Ticker mentions count")
```

From the graph above, we can see that `GME` and `AMC` are the dominant 2 dominant stocks that were discussed in WallStreeBets sub-reddit, which appears in around `r round(df$count[1]/sum(df$count)*100, 4)`% and `r round(df$count[2]/sum(df$count)*100, 4)`% of the total posts respectively. However, ``BB`, `NOK`, `SND` and the other stocks have also received some public attention, which are worthwhile to include them in the future analysis to get a bigger and clearer picture regarding the WSB stocks.

### Time Series of the Top 10 Stocks
Now, we want to study how the top 10 stocks' prices move over the past one year. Again, since the closing price is the most representative price among all the 5 prices, we just use closing price to show the price change over time.

```{r}
df_price <- read.csv('data/clean/stock/top_10_stocks_daily_return.csv')
df_price %>%
  select(Date, Symbol, Daily_return) %>%
  filter(Date >= as.Date('2021-01-01')) %>%
  filter(Date <= as.Date('2021-09-01')) %>%
  filter(Symbol != "^GSPC") %>%
  pivot_wider(names_from = Symbol, values_from = Daily_return, values_fill = 0) %>%
  gather(key = "variable", value = "value", -Date) -> df_price

ts_plot <- 
  ggplot(data=df_price, aes(x=Date, y=value, group = variable, colour = variable)) +
    geom_line() +
    labs(y= "Daily Return", x = "Date") + 
    ggtitle("Daily Return of Top 10 mentioned Stocks")
 
ts_plot
```


## r/WallStreetBets Reddit Post Data

### r/WallStreetBets metrics

```{r}
reddit_sub <- readr::read_csv("data/clean/reddit/reddit_sub_growth.csv") %>%
  mutate(Date = as.Date(Date, format = "'%Y-%m-%d'"))

reddit_sub %>%
  hchart("line",hcaes(x = Date, y = growth)) %>%
  hc_chart(zoomType = "x") %>%
  hc_colors(c(light_blue)) %>%
  hc_legend(align = "center", verticalAlign = "bottom",layout = "horizontal") %>%
  hc_xAxis(title = list(text = "Date"),
           labels = list(format = '{value:%b %d}')) %>%
  hc_yAxis(title = list(text = "Subscriber growth")) %>%
  hc_title(text = "<b>r/WallStreetBets subscriber growth by Date</b>") %>%
  hc_subtitle(text = "Click and drag in the plot area to zoom in on a time span") %>%
  hc_plotOptions(area = list(lineWidth = 0.5)) %>% 
  hc_exporting(enabled = TRUE)
```

```{r}
reddit_post_ov <- readr::read_csv("data/clean/reddit/wsb_subreddit_overview.csv") %>%
  # select(date_utc, post_cnt, )
  rename(Date = date_utc) %>%
  pivot_longer(!Date, names_to = "attribute", values_to = "value")

reddit_post_ov_ts <- reddit_post_ov %>%
  hchart("line",hcaes(x = Date, y = value, group = attribute)) %>%
  hc_chart(zoomType = "x") %>%
  hc_colors(c(light_blue, light_red, green, purple)) %>%
  hc_legend(align = "center", verticalAlign = "bottom",layout = "horizontal") %>%
  hc_xAxis(title = list(text = "Date"),
           labels = list(format = '{value:%b %d}')) %>%
  hc_yAxis(title = list(text = "Subscriber growth")) %>%
  hc_title(text = "<b>r/WallStreetBets Daily active users and posts count</b>") %>%
  hc_subtitle(text = "Click and drag in the plot area to zoom in on a time span") %>%
  hc_plotOptions(area = list(lineWidth = 0.5)) %>% 
  hc_exporting(enabled = TRUE)


hc_add_annotation(
    reddit_post_ov_ts,
    labelOptions = list(
      backgroundColor = 'rgba(0,0,0,0.4)',
      verticalAlign = 'top',
      y = 15
    ),
    labels = list(
      list(point = list(xAxis = 0, yAxis = 0,
          x = datetime_to_timestamp(as.Date("2021/01/28")),
          y = 170000), text = "First wave"),
      list(point = list(xAxis = 0, yAxis = 0,
          x = datetime_to_timestamp(as.Date("2021/06/03")),
          y = 17000), text = "Second wave")
    )
)
```

### Reddit metrics vs. stock price
```{r}

AMC_2021 <- getSymbols('AMC', src="yahoo", from = "2021-01-01", auto.assign = FALSE)
amc_price_diff <- data.frame(Date=index(AMC_2021),coredata(AMC_2021)) %>%
  select(Date, ends_with("Close")) %>%
  rename(price = ends_with("Close")) %>%
  mutate(price_diff = price - lag(price)) %>%
  select(Date, price_diff)

amc_reddit_post <- readr::read_csv("data/clean/reddit/wsb_subreddit_overview.csv") %>%
  rename(Date = date_utc) %>%
  select(Date, amc_cnt)
  
amc_post_vs_diff <- merge(amc_reddit_post, amc_price_diff) %>%
  drop_na() 

amc_scatter <- ggplot(amc_post_vs_diff, aes(x = amc_cnt, 
                          y = price_diff))+
  geom_point(color = light_red) +
  geom_text(
    aes(label = ifelse(gme_cnt >= 3000, as.character(Date), "")),
    hjust=1, vjust=0, size=2) +
  labs(x = "# of posts in r/WallStreetBets", 
       y = "daily price change", 
       title = "AMC")+
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom",
        legend.title = element_text(face="bold"))
```
```{r}
GME_2021 <- getSymbols('GME', src="yahoo", from = "2021-01-01", auto.assign = FALSE)
gme_price_diff <- data.frame(Date=index(GME_2021),coredata(GME_2021)) %>%
  select(Date, ends_with("Close")) %>%
  rename(price = ends_with("Close")) %>%
  mutate(price_diff = price - lag(price)) %>%
  select(Date, price_diff)

gme_reddit_post <- readr::read_csv("data/clean/reddit/wsb_subreddit_overview.csv") %>%
  rename(Date = date_utc) %>%
  select(Date, gme_cnt)
  
gme_post_vs_diff <- merge(gme_reddit_post, gme_price_diff) %>%
  drop_na() 

gme_scatter <- ggplot(gme_post_vs_diff, aes(x = gme_cnt, 
                          y = price_diff))+
  geom_point(color = light_blue) +
  geom_text(
    aes(label = ifelse(gme_cnt >= 10000, as.character(Date), "")),
    hjust=1, vjust=0, size=2) +
  labs(x = "# of posts in r/WallStreetBets", 
       y = "daily price change", 
       title = "GME")+
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "bold", color = "grey35"),
        plot.caption = element_text(color = "grey68"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom",
        legend.title = element_text(face="bold"))

amc_scatter + gme_scatter
```


### What are the most popular words?
```{r}
reddit_wc <- readr::read_csv("data/clean/reddit/reddit_wc_total.csv")
wordcloud2(data=reddit_wc, size=0.7, maxRotation = 0, minRotation = 0)
```


### Sentiment analysis on Reddit posts regarding GME
```{r echo=FALSE, message=FALSE}
gme_nrc_first_wave <- readr::read_csv("data/clean/reddit/gme_sa_nrc_first_wave.csv")
gme_nrc_second_wave <- readr::read_csv("data/clean/reddit/gme_sa_nrc_second_wave.csv")
neg_sentiments = c('anger', 'disgust', 'fear', 'negative', 'sadness')
```
```{r}
first_wave <- gme_nrc_first_wave %>%
  select(sentiment, wordCount) %>%
  group_by(sentiment) %>%
  dplyr::summarise(wordCount = sum(wordCount)) %>%
  mutate(label = ifelse(sentiment %in% neg_sentiments, 'neg', 'pos')) %>%
  ggplot(aes(x = fct_reorder(sentiment, desc(wordCount)), y = wordCount)) +
    geom_bar(stat = "identity", aes(fill = label)) +
    scale_fill_manual(values = c("neg" = green,
                                "pos" = light_red)) +
    ggtitle("GME Sentiment Jan and Feb") +
    xlab("sentiment")
second_wave <- gme_nrc_second_wave %>%
  select(sentiment, wordCount) %>%
  group_by(sentiment) %>%
  dplyr::summarise(wordCount = sum(wordCount)) %>%
  mutate(label = ifelse(sentiment %in% neg_sentiments, 'neg', 'pos')) %>%
  ggplot(aes(x = fct_reorder(sentiment, desc(wordCount)), y = wordCount)) +
    geom_bar(stat = "identity", aes(fill = label)) +
    scale_fill_manual(values = c("neg" = green,
                                "pos" = light_red)) +
    ggtitle("GME Sentiment May, Jun and Jul") +
    xlab("sentiment")
first_wave / second_wave
```

```{r}
gme_nrc_total <- rbind(gme_nrc_first_wave, gme_nrc_second_wave)
gme_nrc_sum <- gme_nrc_total %>%
  mutate(label = ifelse(sentiment %in% neg_sentiments, 'neg', 'pos')) %>%
  group_by(textDate, label) %>%
  summarise(wordCount = sum(wordCount)) %>%
  ungroup() %>%
  pivot_wider(id_cols = textDate, names_from = label, values_from = wordCount) %>%
  mutate(positive_percentage = pos/(pos+neg)) %>%
  mutate(positive_percentage = (positive_percentage - min(positive_percentage))/(max(positive_percentage)-min(positive_percentage))*100) %>%
  select(textDate, positive_percentage)
textDate <- seq(as.Date("2021/3/1"), as.Date("2021/5/30"), "days")
empty_df <- data.frame(textDate)
empty_df$positive_percentage <- NA
gme_nrc_sum <- rbind(gme_nrc_sum, empty_df)
gme_stock <- getSymbols("GME", src="yahoo", from = "2021-01-01", to = "2021-07-31", auto.assign = FALSE)
gme_stock_df <- data.frame(Date=index(gme_stock),coredata(gme_stock)) %>% 
  mutate(price = (GME.Close - min(GME.Close))/(max(GME.Close)-min(GME.Close))*100) %>%
  select(Date, price)
total <- merge(gme_stock_df, gme_nrc_sum, by.y="textDate", by.x="Date") %>%
  pivot_longer(!Date, names_to = "attr", values_to = "val")
ggplot(total, aes(x=Date, y=val, color=attr)) +
  geom_line() +
  scale_color_manual(values = c(light_blue, light_red)) +
  ggtitle("GME positive percentage and stock price") +
  ylab("value") +
  labs(color = "") +
  theme_bw() +
  theme(plot.title = element_text(face = "bold"),
        plot.caption = element_text(color = "grey68"),
        legend.position="bottom")
```

Above plot analyzes if the sentiments on r/WallStreetBets had any impact on GME's stock price.


